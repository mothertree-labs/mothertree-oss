#cloud-config
# Cloud-init user data for Jitsi tester instance
# Installs Ubuntu Desktop and VNC server for GUI testing

package_update: true
package_upgrade: true

packages:
  - ubuntu-desktop-minimal
  - tigervnc-standalone-server
  - tigervnc-common
  - xfce4
  - xfce4-goodies
  - firefox
  - curl
  - wget
  - expect

# Set up VNC server for the default user (root or ubuntu depending on image)
write_files:
  # Create VNC startup script with XFCE desktop
  - path: /root/.vnc/xstartup
    permissions: '0755'
    content: |
      #!/bin/bash
      unset SESSION_MANAGER
      unset DBUS_SESSION_BUS_ADDRESS
      export XKL_XMODMAP_DISABLE=1
      export XDG_CURRENT_DESKTOP="XFCE"
      export XDG_MENU_PREFIX="xfce-"
      [ -r $HOME/.Xresources ] && xrdb $HOME/.Xresources
      xfce4-session &
      wait

  # Create systemd service for VNC server
  - path: /etc/systemd/system/vncserver@.service
    content: |
      [Unit]
      Description=Remote desktop service (VNC)
      After=syslog.target network.target

      [Service]
      Type=forking
      User=root
      ExecStartPre=/bin/sh -c '/usr/bin/vncserver -kill :%i > /dev/null 2>&1 || :'
      ExecStart=/usr/bin/vncserver -depth 24 -geometry 1920x1080 :%i
      ExecStop=/usr/bin/vncserver -kill :%i
      Restart=on-failure

      [Install]
      WantedBy=multi-user.target
    permissions: '0644'
    owner: root:root

  # Disable screen locking and power management for testing
  - path: /etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xfce4-power-manager.xml
    content: |
      <?xml version="1.0" encoding="UTF-8"?>
      <channel name="xfce4-power-manager" version="1.0">
        <property name="xfce4-power-manager" type="empty">
          <property name="dpms-enabled" type="bool" value="false"/>
          <property name="blank-on-ac" type="int" value="0"/>
          <property name="dpms-on-ac-off" type="int" value="0"/>
          <property name="dpms-on-ac-sleep" type="int" value="0"/>
        </property>
      </channel>
    permissions: '0644'
    owner: root:root

  # Write a helpful message to motd about VNC access
  - path: /etc/motd
    content: |
      Jitsi Tester Instance
      ====================
      
      This instance has Ubuntu Desktop and VNC server installed.
      
      To access the GUI via VNC:
      1. SSH into this instance: ssh root@<instance-ip>
      2. Create an SSH tunnel: ssh -L 5901:localhost:5901 root@<instance-ip>
      3. Connect your VNC client to localhost:5901
      4. Default VNC password: password (CHANGE THIS!)
      
      Note: VNC is only accessible via SSH port forwarding for security.
      
    append: false

runcmd:
  # Create VNC directory and set up VNC server
  - mkdir -p /root/.vnc
  # Set VNC password (default: "password" - should be changed after first login)
  # Use expect to set password non-interactively
  - |
    expect << EOF
    spawn vncpasswd
    expect "Password:"
    send "password\r"
    expect "Verify:"
    send "password\r"
    expect "Would you like to enter a view-only password (y/n)?"
    send "n\r"
    expect eof
    EOF
  - chmod 600 /root/.vnc/passwd
  # Enable and start VNC server on display :1
  - systemctl daemon-reload
  - systemctl enable vncserver@1.service
  - systemctl start vncserver@1.service

# Ensure cloud-init completes before other services start
final_message: "Jitsi tester instance setup complete. Ubuntu Desktop and VNC server are installed."
