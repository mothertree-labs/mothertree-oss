apiVersion: batch/v1
kind: Job
metadata:
  name: k6-docs-load
  namespace: perf
  labels:
    env: prod
    app: docs
spec:
  ttlSecondsAfterFinished: 600
  template:
    metadata:
      labels:
        env: prod
        app: docs
    spec:
      restartPolicy: Never
      containers:
        - name: k6
          image: ghcr.io/YOUR_ORG/mothertree-perf:latest
          args:
            - run
            - k6/docs/load.js
            - --env
            - ENV=prod
            - --out
            - json=/shared/k6-results.json
          resources:
            requests:
              cpu: "250m"
              memory: "256Mi"
            limits:
              cpu: "1"
              memory: "1Gi"
          volumeMounts:
            - name: shared
              mountPath: /shared
        - name: converter
          image: python:3-alpine
          command: ["sh", "-c", "pip install -q requests && python3 /scripts/converter.py"]
          env:
            - name: K6_JSON_FILE
              value: /shared/k6-results.json
            - name: PUSHGATEWAY_URL
              value: http://prometheus-pushgateway.monitoring.svc.cluster.local:9091
            - name: JOB_NAME
              value: k6-docs-load
            - name: ENV
              value: prod
            - name: APP
              value: docs
            - name: POLL_INTERVAL
              value: "5.0"
          volumeMounts:
            - name: shared
              mountPath: /shared
            - name: converter-script
              mountPath: /scripts
          resources:
            requests:
              cpu: "50m"
              memory: "64Mi"
            limits:
              cpu: "100m"
              memory: "128Mi"
      volumes:
        - name: shared
          emptyDir: {}
        - name: converter-script
          configMap:
            name: k6-json-converter
            defaultMode: 0755


