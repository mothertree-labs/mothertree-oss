# Nextcloud Configuration
# Conservative resource allocation for 2-node cluster
# Uses shared PostgreSQL database (docs-postgresql)

# Replica count
replicaCount: 1

# Disable internal SQLite database
internalDatabase:
  enabled: false

# External database configuration (shared PostgreSQL in 'infra-db' namespace)
# Note: A dedicated secret 'nextcloud-db' will be created by deploy-nextcloud.sh
# IMPORTANT: The password is sourced from docs-secrets.DATABASE_PASSWORD (the authoritative source)
# User and database are per-tenant (e.g., docs_example, nextcloud_example)
externalDatabase:
  enabled: true
  type: postgresql
  # host is set in environment-specific files (apps/environments/<env>/nextcloud.yaml.gotmpl)
  # to support both standalone (docs-postgresql) and replication (docs-postgresql-primary) architectures
  host: docs-postgresql.infra-db.svc.cluster.local  # default, overridden per environment
  user: ""  # Set per-tenant in environment values (e.g., docs_example)
  password: ""
  database: ""  # Set per-tenant in environment values (e.g., nextcloud_example)
  existingSecret:
    enabled: true
    secretName: nextcloud-db
    usernameKey: db-username
    passwordKey: db-password

# Resource limits - tuned based on actual usage (~125Mi observed)
resources:
  requests:
    cpu: 10m
    memory: 192Mi
  limits:
    cpu: 1000m
    memory: 512Mi

# Persistence for Nextcloud config/cache (primary data is in S3)
# Note: With S3 enabled, this is only needed for config and cache.
# New deployments could use 2Gi, but existing deployments keep their current size
# because Linode block storage volumes cannot be resized down.
persistence:
  enabled: true
  size: 10Gi
  storageClass: linode-block-storage-retain
  accessMode: ReadWriteOnce

# Ingress will be configured in environment-specific files
ingress:
  enabled: false

# Nextcloud configuration
nextcloud:
  host: ""  # Set in environment-specific files
  username: admin
  password: ""  # Will be auto-generated by Helm chart
  # Custom config.php settings
  configs:
    # Disable default skeleton files for new users (empty filesystem)
    skeleton.config.php: |-
      <?php
      $CONFIG = array (
        'skeletondirectory' => '',
      );

  # Init container to install Pandoc static binary for DOCX conversion
  # Downloads official static release from GitHub - works on any Linux (glibc or musl)
  extraInitContainers:
    - name: install-pandoc
      image: alpine:3.20
      command:
        - sh
        - -c
        - |
          wget -qO- https://github.com/jgm/pandoc/releases/download/3.6/pandoc-3.6-linux-amd64.tar.gz \
            | tar xz --strip-components=2 -C /pandoc-bin pandoc-3.6/bin/pandoc
      volumeMounts:
        - name: pandoc-bin
          mountPath: /pandoc-bin

  # Shared volume for pandoc binary
  extraVolumes:
    - name: pandoc-bin
      emptyDir: {}

  # Mount pandoc binary in Nextcloud container
  extraVolumeMounts:
    - name: pandoc-bin
      mountPath: /usr/local/bin/pandoc
      subPath: pandoc

# OIDC configuration is done via the nextcloud-oidc-config-job after deployment
# This ensures Nextcloud is fully installed before configuring OIDC

# PHP configuration for HTTPS behind proxy
phpClientHttpsFix:
  enabled: true
  protocol: https

# Disable built-in Redis (we have our own)
redis:
  enabled: false

# Disable built-in MariaDB (we use PostgreSQL)
mariadb:
  enabled: false

# Disable built-in PostgreSQL subchart (we use the shared docs-postgresql)
postgresql:
  enabled: false
