#!/bin/bash
# Configure mail routing for all tenants
# 
# This script scans tenants/<name>/<env>.config.yaml files and configures:
# 1. K8s Postfix routing ConfigMap (transport maps, relay_domains)
# 2. K8s Postfix ALLOWED_SENDER_DOMAINS env var
# 3. VPN Postfix transport maps (via Ansible if --vpn flag is passed)
#
# Called by:
# - deploy_infra (with --vpn to also configure VPN Postfix)
# - create_env (without --vpn, just updates K8s side)
# - deploy-stalwart.sh (without --vpn, just updates K8s side)
#
# Usage:
#   ./scripts/configure-mail-routing <env> [--vpn]

set -euo pipefail

REPO="${REPO:-$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)}"

# Parse arguments (positional env + named options)
NESTING_LEVEL=0
MT_ENV=""
CONFIGURE_VPN=""
for arg in "$@"; do
  case "$arg" in
    --nesting-level=*) NESTING_LEVEL="${arg#*=}" ;;
    --vpn) CONFIGURE_VPN="--vpn" ;;
    *) [ -z "$MT_ENV" ] && MT_ENV="$arg" ;;
  esac
done
_MT_NOTIFY_NESTING_LEVEL=$NESTING_LEVEL

source "${REPO}/scripts/lib/notify.sh"
mt_deploy_start "configure-mail-routing"

if [ -z "$MT_ENV" ]; then
  echo "Usage: $0 <env> [--vpn]"
  exit 1
fi

# Use environment kubeconfig
export KUBECONFIG="$REPO/kubeconfig.$MT_ENV.yaml"
if [ ! -f "$KUBECONFIG" ]; then
  echo "[ERROR] Kubeconfig not found: $KUBECONFIG"
  exit 1
fi

NS_MAIL="infra-mail"

echo "[INFO] Scanning tenants for mail routing configuration (env: $MT_ENV)..."

# Arrays to collect tenant data
TENANT_DOMAINS=""
TENANT_TRANSPORTS=""
TENANT_RELAY_DOMAINS=""
ALLOWED_SENDER_DOMAINS=""

for tenant_dir in "$REPO/tenants"/*/; do
  tenant_name=$(basename "$tenant_dir")
  config_file="$tenant_dir/${MT_ENV}.config.yaml"
  
  if [ -f "$config_file" ]; then
    base_domain=$(yq '.dns.domain' "$config_file")
    env_label=$(yq '.dns.env_dns_label // ""' "$config_file")
    
    # Construct the actual mail domain using env_dns_label prefix if set
    # e.g., dev.example.com for dev, example.com for prod
    if [ -n "$env_label" ] && [ "$env_label" != "null" ]; then
      domain="${env_label}.${base_domain}"
    else
      domain="$base_domain"
    fi
    
    if [ -n "$domain" ] && [ "$domain" != "null" ]; then
      echo "[INFO] Found tenant: $tenant_name -> $domain (base: $base_domain, env_label: ${env_label:-none})"
      
      # Build space-separated domain list
      TENANT_DOMAINS="${TENANT_DOMAINS:+$TENANT_DOMAINS }$domain"
      
      # Build comma-separated list for ALLOWED_SENDER_DOMAINS env var
      ALLOWED_SENDER_DOMAINS="${ALLOWED_SENDER_DOMAINS:+$ALLOWED_SENDER_DOMAINS,}$domain"
      
      # K8s Postfix routes to Stalwart via K8s DNS (resilient to pod changes)
      stalwart_svc="stalwart.tn-${tenant_name}-mail.svc.cluster.local"
      TENANT_TRANSPORTS="${TENANT_TRANSPORTS}    ${domain}    smtp:[${stalwart_svc}]:25
"
      TENANT_RELAY_DOMAINS="${TENANT_RELAY_DOMAINS}    ${domain} OK
"
    fi
  fi
done

if [ -z "$TENANT_DOMAINS" ]; then
  echo "[WARN] No tenant configs found for environment $MT_ENV"
fi

# =============================================================================
# Update K8s Postfix routing ConfigMap
# =============================================================================
echo "[INFO] Updating Postfix routing ConfigMap..."
kubectl apply -f - <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: postfix-routing
  namespace: $NS_MAIL
  annotations:
    description: "Multi-tenant inbound mail routing - auto-generated by configure-mail-routing"
data:
  transport: |
    # Multi-tenant mail routing - managed by configure-mail-routing
    # Auto-generated on $(date -u +"%Y-%m-%dT%H:%M:%SZ")
${TENANT_TRANSPORTS}
  relay_domains: |
    # Domains accepting inbound mail - managed by configure-mail-routing
    # Auto-generated on $(date -u +"%Y-%m-%dT%H:%M:%SZ")
${TENANT_RELAY_DOMAINS}
EOF
echo "[INFO] Postfix routing ConfigMap updated"

# =============================================================================
# Update K8s Postfix ALLOWED_SENDER_DOMAINS
# =============================================================================
if [ -n "$ALLOWED_SENDER_DOMAINS" ]; then
  echo "[INFO] Updating K8s Postfix ALLOWED_SENDER_DOMAINS: $ALLOWED_SENDER_DOMAINS"
  kubectl set env deployment/postfix -n "$NS_MAIL" \
    -c postfix ALLOWED_SENDER_DOMAINS="$ALLOWED_SENDER_DOMAINS" 2>/dev/null || \
    echo "[WARN] Could not update postfix deployment - may not exist yet"
fi

# =============================================================================
# Restart K8s Postfix to apply changes
# =============================================================================
echo "[INFO] Restarting K8s Postfix to apply routing changes..."
kubectl rollout restart deployment/postfix -n "$NS_MAIL" 2>/dev/null || \
  echo "[WARN] Could not restart postfix - may not exist yet"

# =============================================================================
# Configure VPN Postfix (only if --vpn flag is passed)
# =============================================================================
if [ "$CONFIGURE_VPN" = "--vpn" ]; then
  echo "[INFO] Configuring VPN Postfix for inbound mail routing..."
  
  # This part is handled by deploy_infra's Ansible section
  # We just export the variables for Ansible to use
  echo "[INFO] VPN Postfix configuration requires Ansible - run deploy_infra for full VPN setup"
  echo "[INFO] Tenant domains for VPN routing: $TENANT_DOMAINS"
fi

echo "[SUCCESS] Mail routing configured for tenants: ${TENANT_DOMAINS:-none}"
