#!/bin/bash

# Infrastructure Management Script
# Purpose: Manage dangerous infrastructure operations (LKE cluster, VPN, TURN servers)
# This script handles phase1 Terraform and should be run manually by operators.
# 
# Usage:
#   ./scripts/manage_infra <env> [options]
#
# Examples:
#   ./scripts/manage_infra prod                    # Apply infrastructure for prod
#   ./scripts/manage_infra dev --jitsi_tester=yes  # Apply with jitsi tester
#   ./scripts/manage_infra prod --plan             # Show what would change
#   ./scripts/manage_infra prod --destroy          # Tear down (requires confirmation)

set -euo pipefail

REPO="${REPO:-$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)}"

# Pre-scan for nesting level (must be set before sourcing notify.sh)
NESTING_LEVEL=0
for arg in "$@"; do
  case "$arg" in
    --nesting-level=*) NESTING_LEVEL="${arg#*=}" ;;
  esac
done
_MT_NOTIFY_NESTING_LEVEL=$NESTING_LEVEL

source "${REPO}/scripts/lib/notify.sh"
mt_notify "————————————————————————————————" "<hr>"
mt_deploy_start "manage_infra"

# Default values
JITSI_TESTER_ENABLED="false"
PLAN_ONLY="false"
DESTROY="false"
MT_ENV=""

usage() {
  echo "Usage: $0 <env> [options]"
  echo ""
  echo "Arguments:"
  echo "  env                    Environment name (e.g., prod, dev)"
  echo ""
  echo "Options:"
  echo "  --jitsi_tester=yes|no  Enable/disable Jitsi tester VM (default: no)"
  echo "  --plan                 Show planned changes without applying"
  echo "  --destroy              Tear down infrastructure (requires confirmation)"
  echo ""
  echo "Examples:"
  echo "  $0 prod                    # Apply infrastructure for prod"
  echo "  $0 dev --jitsi_tester=yes  # Apply dev with Jitsi tester"
  echo "  $0 prod --plan             # Preview changes for prod"
  echo "  $0 prod --destroy          # Destroy prod infrastructure"
}

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --jitsi_tester=yes)
      JITSI_TESTER_ENABLED="true"
      shift
      ;;
    --jitsi_tester=no)
      JITSI_TESTER_ENABLED="false"
      shift
      ;;
    --jitsi_tester=*)
      echo "[ERROR] Invalid value for --jitsi_tester. Use 'yes' or 'no'." >&2
      exit 1
      ;;
    --plan)
      PLAN_ONLY="true"
      shift
      ;;
    --destroy)
      DESTROY="true"
      shift
      ;;
    --nesting-level=*)
      # Already parsed above
      shift
      ;;
    --help|-h)
      usage
      exit 0
      ;;
    --*)
      echo "[ERROR] Unknown option: $1" >&2
      usage
      exit 1
      ;;
    *)
      if [ -z "$MT_ENV" ]; then
        MT_ENV="$1"
      else
        echo "[ERROR] Unexpected argument: $1" >&2
        usage
        exit 1
      fi
      shift
      ;;
  esac
done

if [ -z "$MT_ENV" ]; then
  echo "[ERROR] Environment name is required" >&2
  usage
  exit 1
fi

echo "[INFO] Managing infrastructure for environment: $MT_ENV"
if [ "$JITSI_TESTER_ENABLED" = "true" ]; then
  echo "[INFO] Jitsi tester instance will be enabled"
fi

# Load shared infrastructure secrets
# These are shared across all tenants (Linode token, SSH keys, etc.)
if [ -f "$REPO/secrets.tfvars.env" ]; then
  # shellcheck disable=SC1091
  source "$REPO/secrets.tfvars.env"
  echo "[INFO] Loaded shared infrastructure secrets from secrets.tfvars.env"
elif [ -f "$REPO/secrets.${MT_ENV}.tfvars.env" ]; then
  # Fallback to environment-specific secrets during migration
  # shellcheck disable=SC1091
  source "$REPO/secrets.${MT_ENV}.tfvars.env"
  echo "[INFO] Loaded secrets from secrets.${MT_ENV}.tfvars.env (legacy)"
else
  echo "[ERROR] No secrets file found. Expected $REPO/secrets.tfvars.env" >&2
  exit 1
fi

# Determine DNS label based on environment
# For prod, use empty label (matrix.example.com)
# For other envs, use env name (matrix.dev.example.com)
ENV_DNS_LABEL="$MT_ENV"
if [ "$MT_ENV" = "prod" ]; then
  ENV_DNS_LABEL=""
fi

pushd "$REPO/phase1" >/dev/null
  echo "[INFO] Phase1: Initializing Terraform..."
  terraform init -input=false
  
  echo "[INFO] Phase1: Selecting workspace '$MT_ENV'..."
  terraform workspace select "$MT_ENV" 2>/dev/null || terraform workspace new "$MT_ENV"
  
  # Build variable file flags (common first, then env-specific overrides)
  #
  # This enables different cluster/node-pool/autoscaler settings for dev vs prod:
  # - Common defaults live in:    $REPO/terraform.tfvars
  # - Env overrides live in:      $REPO/terraform.<env>.tfvars  (e.g., terraform.dev.tfvars)
  #
  # Terraform applies var-files in order; later files override earlier ones.
  VAR_FILE_FLAGS=()
  if [ -f "$REPO/terraform.tfvars" ]; then
    VAR_FILE_FLAGS+=("-var-file=$REPO/terraform.tfvars")
  fi
  if [ -f "$REPO/terraform.${MT_ENV}.tfvars" ]; then
    echo "[INFO] Using environment-specific overrides: $REPO/terraform.${MT_ENV}.tfvars"
    VAR_FILE_FLAGS+=("-var-file=$REPO/terraform.${MT_ENV}.tfvars")
  fi
  
  if [ "$DESTROY" = "true" ]; then
    echo ""
    echo "============================================================"
    echo "[WARNING] This will DESTROY all infrastructure for '$MT_ENV'!"
    echo "============================================================"
    echo ""
    echo "This includes:"
    echo "  - LKE Kubernetes cluster"
    echo "  - OpenVPN server"
    echo "  - TURN server"
    echo "  - All associated firewalls and VPC resources"
    echo ""
    read -p "Type 'destroy $MT_ENV' to confirm: " confirm
    if [ "$confirm" != "destroy $MT_ENV" ]; then
      echo "[INFO] Destruction cancelled"
      exit 1
    fi
    
    echo "[INFO] Phase1: Destroying infrastructure..."
    terraform destroy -auto-approve "${VAR_FILE_FLAGS[@]}" \
      -var env="$MT_ENV" \
      -var env_dns_label="$ENV_DNS_LABEL" \
      -var jitsi_tester_enabled="$JITSI_TESTER_ENABLED"
      
  elif [ "$PLAN_ONLY" = "true" ]; then
    echo "[INFO] Phase1: Planning changes..."
    terraform plan "${VAR_FILE_FLAGS[@]}" \
      -var env="$MT_ENV" \
      -var env_dns_label="$ENV_DNS_LABEL" \
      -var jitsi_tester_enabled="$JITSI_TESTER_ENABLED"
      
  else
    echo "[INFO] Phase1: Applying infrastructure..."
    terraform apply -input=false -auto-approve "${VAR_FILE_FLAGS[@]}" \
      -var env="$MT_ENV" \
      -var env_dns_label="$ENV_DNS_LABEL" \
      -var jitsi_tester_enabled="$JITSI_TESTER_ENABLED"
    
    # Extract outputs for reference
    echo ""
    echo "[INFO] Infrastructure outputs:"
    TURN_SERVER_IP=$(terraform output -raw turn_server_ip 2>/dev/null || echo "")
    if [ -n "$TURN_SERVER_IP" ] && [ "$TURN_SERVER_IP" != "null" ]; then
      echo "  TURN server IP: $TURN_SERVER_IP"
    fi
    
    VPN_SERVER_IP=$(terraform output -raw openvpn_server_ip 2>/dev/null || echo "")
    if [ -n "$VPN_SERVER_IP" ] && [ "$VPN_SERVER_IP" != "null" ]; then
      echo "  VPN server IP: $VPN_SERVER_IP"
    fi
    
    echo "  Kubeconfig: $REPO/kubeconfig.$MT_ENV.yaml"
  fi
popd >/dev/null

echo ""
echo "[SUCCESS] Infrastructure management complete for '$MT_ENV'"

if [ "$PLAN_ONLY" != "true" ] && [ "$DESTROY" != "true" ]; then
  echo ""
  echo "Next steps:"
  echo "  1. Verify kubeconfig: export KUBECONFIG=$REPO/kubeconfig.$MT_ENV.yaml"
  echo "  2. Check cluster: kubectl get nodes"
  echo "  3. Deploy tenant: ./scripts/create_env --tenant=<name> $MT_ENV"
fi
