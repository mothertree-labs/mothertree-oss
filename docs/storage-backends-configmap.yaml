apiVersion: v1
kind: ConfigMap
metadata:
  name: storage-backends
  namespace: docs
  labels:
    app.kubernetes.io/name: docs
    app.kubernetes.io/part-of: mother-tree
data:
  storage_backends.py: |
    from storages.backends.s3boto3 import S3Boto3Storage
    import botocore.config
    from boto3.s3.transfer import TransferConfig

    class LinodeS3Boto3Storage(S3Boto3Storage):
        """
        Custom S3 storage backend for Linode Object Storage.
        Uses boto3 1.35.99 for compatibility.
        Generates presigned URLs for private files.
        """
        
        def __init__(self, *args, **kwargs):
            super().__init__(*args, **kwargs)
            # Set transfer config with very high multipart threshold
            self.transfer_config = TransferConfig(
                multipart_threshold=5 * 1024 * 1024 * 1024,  # 5 GB
                max_concurrency=1,
                use_threads=False,
            )
            # Keep files private - middleware will handle presigned URLs
            self.default_acl = 'private'
            # Don't use querystring auth by default, we'll override url() for presigned URLs
            self.querystring_auth = False
        
        def _get_client(self):
            session = botocore.session.get_session()
            client = session.create_client(
                's3',
                region_name=self.region_name,
                endpoint_url=self.endpoint_url,
                aws_access_key_id=self.access_key,
                aws_secret_access_key=self.secret_key,
                config=botocore.config.Config(
                    s3={
                        'use_accelerate_endpoint': False,
                    },
                    retries={'max_attempts': 0},
                    signature_version='s3v4'
                )
            )
            return client
        
        def url(self, name):
            """
            Generate a presigned URL for private files.
            URLs expire after 1 hour.
            """
            if self.file_overwrite:
                name = self._normalize_name(self._clean_name(name))
            else:
                name = self._normalize_name(self.clean_name(name))
            
            # Generate a presigned URL that expires in 1 hour
            url_params = {'Expires': 3600}
            
            try:
                url = self.client.generate_presigned_url(
                    'get_object',
                    Params={'Bucket': self.bucket_name, 'Key': name},
                    ExpiresIn=3600
                )
                return url
            except Exception as e:
                # Fallback to regular URL if presigned generation fails
                return super().url(name)

  middleware.py: |
    """
    Django middleware to handle /media requests and return presigned URLs for private S3 files.
    """
    import os
    from django.http import HttpResponseRedirect, Http404
    import boto3
    from botocore.config import Config

    def get_s3_client():
        """Get S3 client with Linode credentials"""
        # Fail fast if required environment variables are not set
        endpoint_url = os.environ.get('AWS_S3_ENDPOINT_URL')
        region_name = os.environ.get('AWS_S3_REGION_NAME')
        access_key = os.environ.get('AWS_S3_ACCESS_KEY_ID')
        secret_key = os.environ.get('AWS_S3_SECRET_ACCESS_KEY')
        
        if not all([endpoint_url, region_name, access_key, secret_key]):
            missing = []
            if not endpoint_url: missing.append('AWS_S3_ENDPOINT_URL')
            if not region_name: missing.append('AWS_S3_REGION_NAME')
            if not access_key: missing.append('AWS_S3_ACCESS_KEY_ID')
            if not secret_key: missing.append('AWS_S3_SECRET_ACCESS_KEY')
            raise ValueError(f"Missing required S3 environment variables: {', '.join(missing)}")
        
        return boto3.client(
            's3',
            endpoint_url=endpoint_url,
            region_name=region_name,
            aws_access_key_id=access_key,
            aws_secret_access_key=secret_key,
            config=Config(
                s3={'use_accelerate_endpoint': False},
                retries={'max_attempts': 0},
                signature_version='s3v4'
            )
        )

    class MediaMiddleware:
        """
        Middleware to intercept /media/ requests and redirect to presigned S3 URLs
        """
        def __init__(self, get_response):
            self.get_response = get_response
            self.s3_client = get_s3_client()
            self.bucket_name = os.environ.get('AWS_STORAGE_BUCKET_NAME')
            if not self.bucket_name:
                raise ValueError("Missing required environment variable: AWS_STORAGE_BUCKET_NAME")

        def __call__(self, request):
            # Check if this is a media request
            if request.path.startswith('/media/'):
                try:
                    # Extract the S3 key from the path
                    s3_key = request.path[len('/media/'):]
                    
                    # Generate a presigned URL valid for 1 hour
                    presigned_url = self.s3_client.generate_presigned_url(
                        'get_object',
                        Params={
                            'Bucket': self.bucket_name,
                            'Key': s3_key
                        },
                        ExpiresIn=3600
                    )
                    
                    # Redirect to the presigned URL
                    return HttpResponseRedirect(presigned_url)
                except Exception as e:
                    # If anything fails, return 404
                    raise Http404(f"Media not found: {e}")
            
            # For all other requests, proceed normally
            return self.get_response(request)
