apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    kompose.cmd: kompose convert
    kompose.version: 1.37.0 (HEAD)
  labels:
    io.kompose.service: backend
    app.kubernetes.io/name: docs-backend
    app.kubernetes.io/part-of: mother-tree
  name: backend
  namespace: docs
spec:
  replicas: ${DOCS_BACKEND_MIN_REPLICAS}
  selector:
    matchLabels:
      io.kompose.service: backend
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  template:
    metadata:
      annotations:
        kompose.cmd: kompose convert
        kompose.version: 1.37.0 (HEAD)
      labels:
        io.kompose.service: backend
        app.kubernetes.io/component: backend
        app.kubernetes.io/instance: docs
        app.kubernetes.io/name: docs
    spec:
      containers:
        - name: backend
          image: lasuite/impress-backend:v4.4.0
          command: ["/bin/sh", "-c"]
          args:
            - |
              pip install --no-cache-dir 'boto3==1.35.99' 'botocore<1.36' && \
              python << 'EOF'
              import os
              import re
              import sys
              
              # Read the settings file
              with open('/app/impress/settings.py', 'r') as f:
                  content = f.read()
              
              # Check if already patched
              if 'impress.middleware.MediaMiddleware' in content:
                  print("Already patched")
                  sys.exit(0)
              
              # Find MIDDLEWARE list and insert our middleware at the beginning
              pattern = r'(MIDDLEWARE = \[)'
              replacement = r'\1\n        "impress.middleware.MediaMiddleware",'
              content = re.sub(pattern, replacement, content, count=1)
              
              # Also patch the STORAGES configuration to use our custom backend
              if 'STORAGES_DEFAULT_BACKEND' in os.environ:
                  storages_pattern = r'("default":\s*\{[^}]*"BACKEND":\s*)"storages\.backends\.s3\.S3Storage"'
                  custom_backend = os.environ.get('STORAGES_DEFAULT_BACKEND', 'storages.backends.s3.S3Storage')
                  content = re.sub(storages_pattern, f'\\1"{custom_backend}"', content, count=1)
                  print(f"Patched STORAGES to use {custom_backend}")
              
              # Write back
              with open('/app/impress/settings.py', 'w') as f:
                  f.write(content)
              
              print("Patched settings.py with MediaMiddleware and custom storage backend")
              EOF
              python /app/patches/patch_invitation.py && \
              exec gunicorn -c /usr/local/etc/gunicorn/impress.py impress.wsgi:application
          ports:
          - containerPort: 8000
            name: http
          envFrom:
          - configMapRef:
              name: docs-config
          - configMapRef:
              name: env-d-yprovider
          volumeMounts:
          - name: storage-backends
            mountPath: /app/storage_backends.py
            subPath: storage_backends.py
          - name: media-middleware
            mountPath: /app/impress/middleware.py
            subPath: middleware.py
          - name: invitation-patch
            mountPath: /app/patches/patch_invitation.py
            subPath: patch_invitation.py
            readOnly: true
          env:
          - name: DJANGO_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: docs-secrets
                key: DJANGO_SECRET_KEY
          - name: COLLABORATION_SERVER_SECRET
            valueFrom:
              secretKeyRef:
                name: docs-secrets
                key: COLLABORATION_SERVER_SECRET
          - name: Y_PROVIDER_API_KEY
            valueFrom:
              secretKeyRef:
                name: docs-secrets
                key: Y_PROVIDER_API_KEY
          - name: DB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: docs-secrets
                key: DATABASE_PASSWORD
          - name: AWS_S3_ACCESS_KEY_ID
            valueFrom:
              secretKeyRef:
                name: docs-secrets
                key: AWS_S3_ACCESS_KEY_ID
          - name: AWS_S3_SECRET_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: docs-secrets
                key: AWS_S3_SECRET_ACCESS_KEY
          - name: OIDC_RP_CLIENT_SECRET
            valueFrom:
              secretKeyRef:
                name: docs-secrets
                key: OIDC_RP_CLIENT_SECRET
          - name: DEFAULT_FILE_STORAGE
            value: "storage_backends.LinodeS3Boto3Storage"
          startupProbe:
            httpGet:
              path: /__lbheartbeat__
              port: 8000
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 12
          livenessProbe:
            httpGet:
              path: /__heartbeat__
              port: 8000
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /__lbheartbeat__
              port: 8000
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          # Memory INCREASED based on actual usage (~385Mi observed)
          resources:
            requests:
              cpu: 100m  # Minimum 100m to prevent HPA triggering on idle fluctuations
              memory: 512Mi
            limits:
              cpu: 500m
              memory: 1Gi
          securityContext:
            runAsUser: 0
      volumes:
      - name: storage-backends
        configMap:
          name: storage-backends
      - name: media-middleware
        configMap:
          name: storage-backends
          items:
            - key: middleware.py
              path: middleware.py
      - name: invitation-patch
        configMap:
          name: docs-invitation-patch
      restartPolicy: Always
