apiVersion: apps/v1
kind: Deployment
metadata:
  name: docs-y-provider
  namespace: docs
  labels:
    app.kubernetes.io/name: docs
    app.kubernetes.io/instance: docs
    app.kubernetes.io/component: yProvider
    app.kubernetes.io/part-of: mother-tree
spec:
  replicas: ${YPROVIDER_MIN_REPLICAS}
  selector:
    matchLabels:
      app.kubernetes.io/name: docs
      app.kubernetes.io/instance: docs
      app.kubernetes.io/component: yProvider
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: docs
        app.kubernetes.io/instance: docs
        app.kubernetes.io/component: yProvider
    spec:
      priorityClassName: critical-service  # Evicted last during resource pressure
      containers:
        # Main y-provider container
        - name: docs
          image: lasuite/impress-y-provider:v4.4.0
          imagePullPolicy: IfNotPresent
          envFrom:
            - configMapRef:
                name: env-d-yprovider
          env:
            - name: COLLABORATION_SERVER_SECRET
              valueFrom:
                secretKeyRef:
                  name: docs-secrets
                  key: COLLABORATION_SERVER_SECRET
            - name: Y_PROVIDER_API_KEY
              valueFrom:
                secretKeyRef:
                  name: docs-secrets
                  key: Y_PROVIDER_API_KEY
          ports:
            - name: http
              containerPort: 4444
          # Liveness: is the y-provider process alive?
          livenessProbe:
            httpGet:
              path: /ping
              port: 4444
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 1
            failureThreshold: 3
          # Readiness: can y-provider talk to backend? (checked by sidecar)
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8081
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          resources:
            requests:
              cpu: 100m  # Minimum 100m to prevent HPA triggering on idle fluctuations
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi
        
        # Health check sidecar - tests backend connectivity
        - name: health-sidecar
          image: busybox:1.36
          imagePullPolicy: IfNotPresent
          command: ["/bin/sh", "/scripts/health-check.sh"]
          env:
            - name: COLLABORATION_BACKEND_BASE_URL
              valueFrom:
                configMapKeyRef:
                  name: env-d-yprovider
                  key: COLLABORATION_BACKEND_BASE_URL
            - name: HEALTH_CHECK_INTERVAL
              value: "10"
            - name: HEALTH_PORT
              value: "8081"
          ports:
            - name: health
              containerPort: 8081
          volumeMounts:
            - name: health-scripts
              mountPath: /scripts
              readOnly: true
          resources:
            requests:
              cpu: 5m
              memory: 16Mi
            limits:
              cpu: 100m
              memory: 32Mi
      
      volumes:
        - name: health-scripts
          configMap:
            name: health-sidecar-scripts
            defaultMode: 0755
